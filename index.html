<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web BLE Dice</title>
    <style>
        /* CSS: Simple, Clean Mobile-First UI */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; text-align: center; padding: 20px; background-color: #f4f4f9; color: #333; }
        
        .container { max-width: 400px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        h1 { margin-top: 0; font-size: 24px; }
        
        /* The Big Dice Number */
        #diceResult { font-size: 100px; font-weight: bold; margin: 20px 0; height: 120px; color: #222; }
        .rolling { color: #888; font-size: 40px !important; line-height: 120px; }
        
        /* Debug Data */
        .data-display { font-family: monospace; font-size: 14px; color: #666; margin-bottom: 20px; }
        
        /* Controls */
        .control-group { margin: 15px 0; text-align: left; background: #eee; padding: 10px; border-radius: 8px; }
        label { font-weight: bold; font-size: 14px; }
        input[type="number"] { width: 60px; padding: 5px; margin-left: 10px; border-radius: 4px; border: 1px solid #ccc; }
        
        /* Buttons */
        button { width: 100%; padding: 15px; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        #btnConnect { background-color: #007bff; color: white; }
        #btnReset { background-color: #dc3545; color: white; }
        button:disabled { background-color: #ccc; }
        
        .status { margin-top: 10px; font-size: 12px; color: #888; }
    </style>
</head>
<body>

<div class="container">
    <h1>ðŸŽ² BLE Smart Dice</h1>

    <div id="status" class="status">Status: Disconnected</div>

    <div id="diceResult">-</div>

    <div class="data-display">
        X: <span id="valX">0.00</span> | Y: <span id="valY">0.00</span> | Z: <span id="valZ">0.00</span>
    </div>

    <div class="control-group">
        <label for="thresholdInput">Gravity Threshold (g):</label>
        <input type="number" id="thresholdInput" value="0.8" step="0.1" min="0.1" max="1.5">
    </div>

    <button id="btnConnect" onclick="connectToDice()">ðŸ”— Connect Dice</button>
    <button id="btnReset" onclick="resetDice()">ðŸ”„ Reset</button>
</div>

<script>
    // --- CONFIGURATION ---
    // IMPORTANT: You must replace these with your device's actual UUIDs.
    // If you don't know them, use a scanner app like "nRF Connect" to find them.
    const SERVICE_UUID = '0000180f-0000-1000-8000-00805f9b34fb'; // Example: Battery Service (REPLACE THIS)
    const CHAR_UUID    = '00002a19-0000-1000-8000-00805f9b34fb'; // Example: Battery Level (REPLACE THIS)

    // Variables
    let device, server, service, characteristic;
    let currentNumber = null;

    // UI Elements
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('diceResult');
    const valXEl = document.getElementById('valX');
    const valYEl = document.getElementById('valY');
    const valZEl = document.getElementById('valZ');
    const thresholdInput = document.getElementById('thresholdInput');

    async function connectToDice() {
        try {
            statusEl.innerText = "Requesting Bluetooth Device...";
            
            // 1. Request Device
            device = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true, // For testing. Better to use filters: [{services: [SERVICE_UUID]}]
                optionalServices: [SERVICE_UUID]
            });

            statusEl.innerText = "Connecting to Server...";
            server = await device.gatt.connect();

            statusEl.innerText = "Getting Service...";
            service = await server.getPrimaryService(SERVICE_UUID);

            statusEl.innerText = "Getting Characteristic...";
            characteristic = await service.getCharacteristic(CHAR_UUID);

            statusEl.innerText = "Starting Notifications...";
            await characteristic.startNotifications();
            characteristic.addEventListener('characteristicvaluechanged', handleData);

            statusEl.innerText = "âœ… Connected to " + device.name;
            document.getElementById('btnConnect').disabled = true;

        } catch (error) {
            console.error(error);
            statusEl.innerText = "âŒ Error: " + error;
        }
    }

    function handleData(event) {
        const value = event.target.value;
        
        // --- PARSING LOGIC ---
        // Assumption: Data comes in as 3 Signed Integers (16-bit) -> X, Y, Z
        // You may need to adjust the offsets (0, 2, 4) depending on your device
        const xRaw = value.getInt16(0, true);
        const yRaw = value.getInt16(2, true);
        const zRaw = value.getInt16(4, true);

        // Convert to G-Force (Assuming 1000 units = 1g)
        const x = xRaw / 1000.0;
        const y = yRaw / 1000.0;
        const z = zRaw / 1000.0;

        updateUI(x, y, z);
        determineOrientation(x, y, z);
    }

    function updateUI(x, y, z) {
        valXEl.innerText = x.toFixed(2);
        valYEl.innerText = y.toFixed(2);
        valZEl.innerText = z.toFixed(2);
    }

    function determineOrientation(x, y, z) {
        // Calculate Total Acceleration (Magnitude)
        const totalG = Math.sqrt(x*x + y*y + z*z);
        const threshold = parseFloat(thresholdInput.value);

        // 1. Detect "Rolling" (Motion)
        // If the dice is shaking, G-force spikes or drops significantly away from 1g
        if (Math.abs(totalG - 1.0) > 0.4) {
            resultEl.innerText = "Rolling...";
            resultEl.className = "rolling";
            return;
        }

        // 2. Detect Face (Stable)
        resultEl.className = ""; // Remove rolling style
        
        // Logic from your requirements:
        if (z > threshold) {
            resultEl.innerText = "1";
        } else if (z < -threshold) {
            resultEl.innerText = "6";
        } else if (y > threshold) {
            resultEl.innerText = "2";
        } else if (y < -threshold) {
            resultEl.innerText = "5";
        } else if (x > threshold) {
            resultEl.innerText = "3";
        } else if (x < -threshold) {
            resultEl.innerText = "4";
        } 
        // If nothing matches threshold (e.g. tilted), keep previous or show -
    }

    function resetDice() {
        resultEl.innerText = "-";
        resultEl.className = "";
    }
</script>

</body>
</html>
